<body>
    <div class="captcha-container" tabindex="1">
        <div class="captcha-header">
            <h2>Play DOOM¬Æ and kill</h2>
            <p>at least 3 monsters</p>
        </div>

        <div class="captcha-canvas-container">
            <div id="status">Downloading...</div>
            <progress id="progress" value="0" max="100" hidden></progress>
            <canvas class="captcha-canvas" id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>
            <div class="mobile-controls">
                <div class="d-pad">
                    <button class="up">‚Üë</button>
                    <button class="left">‚Üê</button>
                    <button class="right">‚Üí</button>
                    <button class="down">‚Üì</button>
                </div>
                <button class="fire-button"></button>
            </div>
        </div>

        <div class="captcha-footer">
            <div class="captcha-controls">
                <button class="captcha-button captcha-refresh-button" aria-label="Refresh challenge"
                    id="refresh-button">
                    <svg class="captcha-refresh-icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M7 12v-2l-4 3 4 3v-2h2.997A6.006 6.006 0 0 0 16 8h-2a4 4 0 0 1-3.996 4H7zM9 2H6.003A6.006 6.006 0 0 0 0 8h2a4 4 0 0 1 3.996-4H9v2l4-3-4-3v2z"
                            fill-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div class="status-message focus">Tap to play</div>
            <div class="status-message death">You died! Try again</div>
            <div class="status-message instructions">Use ‚Üì ‚Üë ‚Üê ‚Üí space</div>
            <button class="captcha-button captcha-verify-button" aria-label="Verify, 0 out of 3 monsters killed"
                id="verify-button">
                <svg class="captcha-verify-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M19 21C19 21.5523 18.5523 22 18 22H14H10H6C5.44771 22 5 21.5523 5 21V18.75C5 17.7835 4.2165 17 3.25 17C2.55964 17 2 16.4404 2 15.75V11C2 5.47715 6.47715 1 12 1C17.5228 1 22 5.47715 22 11V15.75C22 16.4404 21.4404 17 20.75 17C19.7835 17 19 17.7835 19 18.75V21ZM17 20V18.75C17 16.9358 18.2883 15.4225 20 15.075V11C20 6.58172 16.4183 3 12 3C7.58172 3 4 6.58172 4 11V15.075C5.71168 15.4225 7 16.9358 7 18.75V20H9V18C9 17.4477 9.44771 17 10 17C10.5523 17 11 17.4477 11 18V20H13V18C13 17.4477 13.4477 17 14 17C14.5523 17 15 17.4477 15 18V20H17ZM11 12.5C11 13.8807 8.63228 15 7.25248 15C5.98469 15 5.99206 14.055 6.00161 12.8306V12.8305C6.00245 12.7224 6.00331 12.6121 6.00331 12.5C6.00331 11.1193 7.12186 10 8.50166 10C9.88145 10 11 11.1193 11 12.5ZM17.9984 12.8306C17.9975 12.7224 17.9967 12.6121 17.9967 12.5C17.9967 11.1193 16.8781 10 15.4983 10C14.1185 10 13 11.1193 13 12.5C13 13.8807 15.3677 15 16.7475 15C18.0153 15 18.0079 14.055 17.9984 12.8306Z"
                        fill="#888888" />
                </svg>
                <span>0/3</span>
            </button>
        </div>
    </div>

    <script>
        window.va =
            window.va ||
            function () {
                (window.vaq = window.vaq || []).push(arguments);
            };
    </script>
    <script defer src="https://doom-captcha.vercel.app/_vercel/insights/script.js"></script>
    <script>
        // Handle taps outside the canvas container
        document.addEventListener("touchstart", (e) => {
            const canvasContainer = document.querySelector(
                ".captcha-canvas-container",
            );
            if (
                !canvasContainer.contains(e.target) &&
                captchaContainer.matches(":focus")
            ) {
                captchaContainer.blur();
            }
        });

        const canvas = document.getElementById("canvas");
        const statusElement = document.getElementById("status");
        const progressElement = document.getElementById("progress");
        const verifyButton = document.getElementById("verify-button");
        const captchaContainer = document.querySelector(".captcha-container");
        const refreshButton = document.getElementById("refresh-button");
        let enemiesKilled = 0;

        function restartGame() {
            enemiesKilled = 0;
            updateVerifyButton();

            // Track game start
            va("event", { name: "game_start" });

            // Call the native DOOM restart function directly
            Module["_G_DoReborn"]();
        }

        function updateVerifyButton() {
            const verifySpan = verifyButton.querySelector("span");
            verifySpan.textContent = `${enemiesKilled}/3`;
            verifyButton.setAttribute(
                "aria-label",
                `Verify, ${enemiesKilled} out of 3 monsters killed`,
            );

            if (enemiesKilled >= 3) {
                verifyButton.style.backgroundColor = "#4285f4";
                verifyButton.style.color = "white";
                verifyButton.style.cursor = "pointer";
            } else {
                verifyButton.style.backgroundColor = "#f0f0f0";
                verifyButton.style.color = "#888";
                verifyButton.style.cursor = "default";
            }
        }

        // prevent losing focus when it's tapped
        refreshButton.addEventListener("mousedown", (e) => {
            e.preventDefault();
        });

        refreshButton.addEventListener("click", (e) => {
            e.preventDefault();
            captchaContainer.focus();
            restartGame();
        });

        function showSuccess() {

            // Track successful solve
            va("event", { name: "captcha_solved", data: { kills: enemiesKilled } });

            // Pause the game
            Module.pauseMainLoop();

            // Hide the captcha container completely
            captchaContainer.style.display = "none";

            // Show success message outside the container
            const successDiv = document.createElement("div");
            successDiv.className = "success-message";
            successDiv.style.display = "block";
            successDiv.innerHTML = `
        <h2>üéâ CAPTCHA solved!</h2>
        <a href="/">Try again</a>
      `;
            document.body.appendChild(successDiv);

            // Lazy load and trigger confetti
            const script = document.createElement("script");
            script.src =
                "https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js";
            script.onload = () => {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                });
            };
            script.onerror = () => {
            };
            document.body.appendChild(script);
        }

        captchaContainer.addEventListener("focus", () => {
            va("event", { name: "game_resume" });
            Module.resumeMainLoop();
        });

        captchaContainer.addEventListener("blur", () => {
            logDebugMessage("CAPTCHA widget unfocused");
            va("event", { name: "game_pause" });
            Module.pauseMainLoop();
        });

        // Mobile controls handling
        const mobileControls = {
            up: { keyCode: 38 }, // Arrow Up
            down: { keyCode: 40 }, // Arrow Down
            left: { keyCode: 37 }, // Arrow Left
            right: { keyCode: 39 }, // Arrow Right
            fire: { keyCode: 32 }, // Space
        };

        function ensureGameFocused() {
            if (!captchaContainer.matches(":focus")) {
                captchaContainer.focus();
            }
        }

        function simulateKeyEvent(type, keyCode) {
            const event = new KeyboardEvent(type, {
                keyCode: keyCode,
                bubbles: true,
                cancelable: true,
            });
            captchaContainer.dispatchEvent(event);
        }

        function handleTouchStart(key) {
            return (e) => {
                e.preventDefault();
                ensureGameFocused();
                simulateKeyEvent("keydown", mobileControls[key].keyCode);
            };
        }

        function handleTouchEnd(key) {
            return (e) => {
                e.preventDefault();
                ensureGameFocused();
                simulateKeyEvent("keyup", mobileControls[key].keyCode);
            };
        }

        // Ensure controls are clickable even when game is not focused
        document.querySelector(".mobile-controls").addEventListener(
            "touchstart",
            (e) => {
                ensureGameFocused();
            },
            { passive: false },
        );

        // Setup touch controls
        document
            .querySelectorAll(".d-pad button, .fire-button")
            .forEach((button) => {
                let key = button.className.split(" ")[0];
                if (!key || key === "fire-button") key = "fire";

                button.addEventListener("touchstart", handleTouchStart(key));
                button.addEventListener("touchend", handleTouchEnd(key));
                button.addEventListener("touchcancel", handleTouchEnd(key));
            });

        var Module = {
            keyboardListeningElement: captchaContainer,
            arguments: [
                "-autoreborn",
                "-nomenu",
                "-fast",
                "-skill",
                "2",
                "-warp",
                "e1m1",
            ],
            preRun: [
                function () {
                    SDL.defaults.copyOnLock = false;

                    // Store the original lookupKeyCodeForEvent function
                    const originalLookupKeyCodeForEvent = SDL.lookupKeyCodeForEvent;

                    // Create a wrapper that modifies key behavior
                    SDL.lookupKeyCodeForEvent = function (event) {
                        // Ignore Escape key by returning 0
                        if (event.keyCode === 27) {
                            captchaContainer.blur();
                            return 0;
                        }

                        // Ignore Ctrl key by returning 0
                        if (event.keyCode === 17) {
                            return 0;
                        }

                        // Treat Spacebar (keyCode 32) as Ctrl
                        if (event.keyCode === 32) {
                            return originalLookupKeyCodeForEvent({ ...event, keyCode: 17 });
                        }

                        // For all other keys, use the original function
                        return originalLookupKeyCodeForEvent(event);
                    };
                },
            ],
            postRun: [],
            onPlayerBorn: function () {
                document
                    .querySelector(".status-message.death")
                    .classList.remove("visible");
            },
            onPlayerDeath: function () {
                logDebugMessage("Player died");
                va("event", { name: "player_death", data: { kills: enemiesKilled } });
                enemiesKilled = 0;
                updateVerifyButton();
                document
                    .querySelector(".status-message.death")
                    .classList.add("visible");
            },
            onEnemyKilled: function () {
                enemiesKilled++;
                va("event", { name: "enemy_killed", data: { kills: enemiesKilled } });
                updateVerifyButton();

                // Get the icon path
                const iconPath = verifyButton.querySelector(
                    ".captcha-verify-icon path",
                );

                // Reset animations
                verifyButton.style.animation = "none";
                iconPath.style.animation = "none";
                verifyButton.offsetHeight; // Trigger reflow

                // Set end colors based on kill count
                const isComplete = enemiesKilled >= 3;
                verifyButton.style.setProperty(
                    "--end-color",
                    isComplete ? "#4285f4" : "#f0f0f0",
                );
                iconPath.style.setProperty(
                    "--end-icon-color",
                    isComplete ? "white" : "#888888",
                );

                // Trigger animations
                verifyButton.style.animation = "killFlash 0.5s ease forwards";
                iconPath.style.animation = "iconFlash 0.5s ease forwards";

                // Show success message when 3 enemies are killed
                if (enemiesKilled === 3) {
                    showSuccess();
                }
            },
            print: function (text) {
                if (arguments.length > 1)
                    text = Array.prototype.slice.call(arguments).join(" ");
                console.log(text);
            },
            printErr: function (text) {
                if (arguments.length > 1)
                    text = Array.prototype.slice.call(arguments).join(" ");
                console.error(text);
            },
            canvas: canvas,
            setStatus: function (text) {
                if (!Module.setStatus.last)
                    Module.setStatus.last = { time: Date.now(), text: "" };
                if (text === Module.setStatus.last.text) return;
                const m = text.match(/([^(]+)$$(\d+(\.\d+)?)\/(\d+)$$/);
                const now = Date.now();
                if (m && now - Module.setStatus.last.time < 30) return;
                Module.setStatus.last.time = now;
                Module.setStatus.last.time = now;
                Module.setStatus.last.text = text;
                if (m) {
                    text = m[1];
                    progressElement.value = parseInt(m[2]) * 100;
                    progressElement.max = parseInt(m[4]) * 100;
                    progressElement.hidden = false;
                } else {
                    progressElement.value = null;
                    progressElement.max = null;
                    progressElement.hidden = true;
                }
                statusElement.innerHTML = text;
            },
            totalDependencies: 0,
            monitorRunDependencies: function (left) {
                this.totalDependencies = Math.max(this.totalDependencies, left);
                Module.setStatus(
                    left
                        ? "Preparing... (" +
                        (this.totalDependencies - left) +
                        "/" +
                        this.totalDependencies +
                        ")"
                        : "All downloads complete.",
                );
            },
        };
        Module.setStatus("Downloading ...");
        window.onerror = function () {
            Module.setStatus("Exception thrown, see JavaScript console");
            Module.setStatus = function (text) {
                if (text) Module.printErr("[post-exception status] " + text);
            };
        };
    </script>
    <script async type="text/javascript" src="https://raw.githubusercontent.com/VoltacceptYT/doom-captcha-ModFiles/refs/heads/main/index.js"></script>
</body>